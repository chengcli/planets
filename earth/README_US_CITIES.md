# US Cities Polygon Tools

This directory contains tools for generating and visualizing US city boundary polygons.

## Overview

The city location database extends the state-level location system by providing polygon boundaries for major cities across the United States. Each city is identified using the format `cityname-stateabbr` (e.g., `pasadena-ca`, `austin-tx`) to uniquely identify cities that may share names across different states.

## Files

- **generate_us_cities_polygons.py**: Script to fetch city boundaries from OpenStreetMap
- **plot_us_cities.py**: Script to visualize city polygons on maps
- **us_cities.csv**: Database of city polygons (generated by the script)

## Scripts

### generate_us_cities_polygons.py

Generate or regenerate the `us_cities.csv` file with city boundary polygons fetched from OpenStreetMap's Nominatim API.

**Important:** This script makes API calls to OpenStreetMap's Nominatim service. Please be respectful of their usage policies and rate limits. The script includes a default 1-second delay between requests.

**Usage:**
```bash
# Generate database for all cities (takes ~4-5 minutes with default delay)
python generate_us_cities_polygons.py

# Generate for specific states only
python generate_us_cities_polygons.py --states California Texas

# Customize output file and vertex count
python generate_us_cities_polygons.py --output custom_cities.csv --max-vertices 40

# Use longer delay for API rate limiting (recommended for bulk fetching)
python generate_us_cities_polygons.py --delay 1.5

# Dry run to see what would be fetched
python generate_us_cities_polygons.py --dry-run --states California
```

**Options:**
- `--output FILE`: Output CSV file path (default: `us_cities.csv`)
- `--max-vertices N`: Maximum vertices per polygon (default: 50)
- `--states STATE [...]`: Only fetch cities for specified states
- `--delay SECONDS`: Delay between API requests (default: 1.0 second, minimum 0.5)
- `--dry-run`: Show what would be fetched without making requests

**Data Source:**
Fetches GeoJSON data from [OpenStreetMap Nominatim API](https://nominatim.openstreetmap.org)

**Cities Included:**
The script includes 226 major cities across all 50 US states, DC, and Puerto Rico, typically covering:
- State capitals
- Largest cities by population (3-5 per state)
- Major metropolitan areas

### plot_us_cities.py

Plot city polygons on a map with coastal lines using various map projections.

**Requirements:**
```bash
pip install matplotlib cartopy
```

**Note:** This script requires cartopy which downloads Natural Earth data for coastlines on first use.

**Usage:**
```bash
# Plot all cities (may be crowded)
python plot_us_cities.py

# Plot specific cities by location ID
python plot_us_cities.py --cities pasadena-ca austin-tx boston-ma

# Plot all cities in specific states (use state abbreviations)
python plot_us_cities.py --states CA TX NY

# Use different projection
python plot_us_cities.py --projection LambertConformal --states CA

# Save to file instead of displaying
python plot_us_cities.py --output california_cities.png --states CA

# Combine options
python plot_us_cities.py --cities seattle-wa portland-or --output pacific_northwest.png
```

**Options:**
- `--locations-file FILE`: Path to CSV file with city polygons (default: `us_cities.csv`)
- `--cities CITY [...]`: Specific cities to plot by location ID (e.g., `pasadena-ca`)
- `--states STATE [...]`: Plot all cities in specified states (use state abbreviations: `CA`, `TX`, etc.)
- `--projection NAME`: Map projection to use (default: `PlateCarree`)
- `--output FILE`: Save to file instead of displaying interactively
- `--no-labels`: Don't show city name labels
- `--figsize WIDTH HEIGHT`: Figure size (default: 15 10)

**Available Projections:**
- `PlateCarree` (default): Simple lat-lon projection
- `LambertConformal`: Lambert conformal conic
- `Mercator`: Mercator projection
- `Orthographic`: Orthographic (globe) projection
- `Robinson`: Robinson projection
- `AlbersEqualArea`: Albers equal-area conic

## Location ID Format

Cities are identified using the format: `cityname-stateabbr`

**Examples:**
- `pasadena-ca` - Pasadena, California
- `pasadena-tx` - Pasadena, Texas (different city, same name)
- `new-york-ny` - New York, New York
- `kansas-city-mo` - Kansas City, Missouri
- `st-louis-mo` - St. Louis, Missouri (apostrophes removed)

**Rules:**
- City names are lowercase
- Spaces become hyphens (-)
- Apostrophes are removed
- State abbreviations are lowercase (ca, tx, ny, etc.)

## Integration with Location System

The city database follows the same format as `locations.csv` and `us_states.csv`:

```
location_id    name                      polygon_vertices
pasadena-ca    Pasadena, California      -118.1,34.1;-118.2,34.2;...
austin-tx      Austin, Texas             -97.7,30.2;-97.8,30.3;...
```

Cities can be used with the unified location system:

```bash
# Generate configuration for a city
python generate_config.py pasadena-ca --locations-file us_cities.csv

# Download weather data for a city
python download_location_data.py pasadena-ca --locations-file us_cities.csv
```

## API Usage Notes

When using `generate_us_cities_polygons.py`:

1. **Rate Limiting**: The script includes automatic delays between requests. Default is 1 second, which is respectful of OpenStreetMap's usage policy.

2. **Usage Policy**: We follow [Nominatim's usage policy](https://operations.osmfoundation.org/policies/nominatim/):
   - Include a valid User-Agent header (done automatically)
   - No more than 1 request per second (configurable via `--delay`)
   - For bulk fetching, consider using longer delays

3. **Bulk Generation**: Generating the complete database (226 cities) takes approximately:
   - 4-5 minutes with 1.0 second delay
   - 7-8 minutes with 1.5 second delay (more polite)

4. **Network Issues**: If API requests fail, the script continues with remaining cities and reports failures at the end. You can re-run for specific states to retry failures.

## Examples

```bash
# Generate California cities only
python generate_us_cities_polygons.py --states California

# Visualize California cities
python plot_us_cities.py --states CA --output ca_cities.png

# Generate Texas and Florida cities with longer delay
python generate_us_cities_polygons.py --states Texas Florida --delay 1.5

# Plot specific major cities
python plot_us_cities.py --cities los-angeles-ca chicago-il new-york-ny \
    --output major_cities.png

# Generate complete database (takes ~4-5 minutes)
python generate_us_cities_polygons.py

# Visualize all cities in the Pacific Northwest
python plot_us_cities.py --states WA OR --output pacific_nw.png
```

## Troubleshooting

**Problem:** Script fails with network errors
- **Solution**: Check internet connection. Nominatim API may be temporarily unavailable.

**Problem:** Some cities not found
- **Solution**: Some smaller cities may not have detailed boundaries in OpenStreetMap. The script will continue and report failures.

**Problem:** "Too many requests" error
- **Solution**: Increase the delay: `--delay 2.0`

**Problem:** Visualization libraries not installed
- **Solution**: Install dependencies: `pip install matplotlib cartopy`

## Data Quality

- City boundaries come from OpenStreetMap and reflect administrative boundaries
- Boundaries are simplified to reduce vertex count (default: 50 vertices max)
- For cities without polygon data, the script creates a small bounding box around the city center
- Polygon quality varies by city; major cities typically have well-defined boundaries

## See Also

- **README_US_STATES.md**: Documentation for state-level polygons
- **README_UNIFIED_SYSTEM.md**: Overview of the unified location system
- **README_EARTH.md**: General Earth location system documentation
